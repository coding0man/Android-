# Android消息机制

这一定是一个被写烂了的专题吧。那本媛也来凑一个热闹吧。哈哈  
这篇博客将会涉及以下内容：

* 消息机制概述
* UML图解消息机制相关类
* Handler
* Looper
* MessageQueue和Message
* 消息机制的应用

##消息机制概述
Android系统在设计的初期就已经考虑到了UI的更新问题，由于Android中的View是线程不安全的，然而程序中异步处理任务结束后更新UI元素也是必须的。这就造成了一个矛盾，最简单的解决方法肯定是给View加同步锁使其变成线程安全的。这样做不是不可以，只是会有两点坏处：  

1. 加锁会有导致效率底下
2. 由于可以在多个地方更新UI，开发就必须很小心操作，开发起来就很麻烦，一不小心就出错了。

基于以上两个缺点，这种方式被抛弃。于是机智如我谷歌爸爸。。。设置一个线程专门处理UI控件的更新，如果其他线程也需要对UI进行更新，不好意思，您把您想做的告诉那个专门处理UI线程的家伙，让它帮你做。大家各有各的任务，井水不犯河水，各司其职，效率才会高，不仅仅对于软件如此，人也是如此，我只管写我的代码，有农民伯伯帮我种吃的、有电脑公司卖给我电脑、有建筑公司给我盖房子（当然了，房子我是万万买不起的... 哼！），这些事儿好像自己也能干，但是都自己干好像就回到了远古时代，人类的进步和发展和社会分工的明确也是离不开的，而且关系很大！
好像扯的有点远了。

那么您也看出来了，消息机制其实可以很简单的用一句话概括，就是：其他线程通过给特定线程发送消息，将某项专职的工作，交给这个特定的线程去做。比如说其他线程都把处理UI显示的工作通过发送消息交给UI线程去做。

这样理解起来是不是就是so easy了呢？

##UML图解消息机制相关类

不知道上面的说法您是否可以对消息机制有了一个基本的认知呢？我曾经在想，怎么通过很简洁直观的方式去把消息机制讲明白（讲给自己，也讲给你）呢，后来我就在想，当初设计者的思路是什么样的呢？我想到了UML图，用类图来对消息机制中涉及到的几个类有一个概括的认识；通过时序图，可以很清晰的观察到整个消息机制的处理过程。  
消息主要设计到下面几个类：

* Handler：这是消息的发出的地方，也是消息处理的地方。
* Looper：这是检测消息的地方。
* MessageQueue:这是存放消息的地方，Handler把消息发到了这里，Looper从这里取出消息交给Handler进行处理
* Message：呜呜呜...他们发的是我，处理的也是我。
* Thread：我在这里专门指代的是，处理消息的线程。消息的发送是在别的线程。

话不多说，先来看一张图（UML忘的差不多了，刚补的，如果有错误，麻烦大家指出）

[消息机制类图](https://raw.githubusercontent.com/coding0man/Android-/master/attachment/MessageClassesUML.png)

图在这里了，怎么看呢，麻烦您先看一下这些类的聚合关系，你会发现，Handler真的是个核心，他几乎拥有所有相关对象的引用。


* Handler拥有Looper的引用，通过得到Looper对象获得Looper中保存的MessageQueue对象
* Handler拥有MessageQueue的引用，使Handler得以拥有发送消息（将Message放入MessageQueue）的能力
* Handler拥有Handler.Callback的引用，使得Handler可以方便的进行消息的处理。